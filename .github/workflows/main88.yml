name: Secure Windows RDP - 24/7 Auto Restart

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'   # Ù‡Ø± Ûµ Ø³Ø§Ø¹Øª

jobs:
  create-rdp:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
      # â”€â”€â”€â”€â”€â”€ Û±. Tailscale (Ø§Ú¯Ù‡ Ø¯Ø§Ø±ÛŒ) â”€â”€â”€â”€â”€â”€
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}

      # â”€â”€â”€â”€â”€â”€ Û². ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RDP â”€â”€â”€â”€â”€â”€
      - name: Enable RDP + Set Credentials
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          net user runneradmin /active:yes
          net user runneradmin "@SecureRDP2026"   # â† Ø±Ù…Ø² Ø¯Ù„Ø®ÙˆØ§Ù‡Øª

      # â”€â”€â”€â”€â”€â”€ Û³. Pinggy Tunnel (Ù†Ø³Ø®Ù‡ Ù‚ÙˆÛŒ Ùˆ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§) â”€â”€â”€â”€â”€â”€
      - name: Start Pinggy Tunnel
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Pinggy Tunnel..." -ForegroundColor Cyan

          # Ø´Ø±ÙˆØ¹ ØªÙˆÙ†Ù„
          Start-Process -FilePath "ssh" `
            -ArgumentList "-p 443 -R0:127.0.0.1:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=5 tcp@free.pinggy.io" `
            -PassThru -NoNewWindow -RedirectStandardOutput "pinggy.log" -RedirectStandardError "pinggy.err"

          # ØµØ¨Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯Ø§Ù†Ù‡ ØªØ§ Ø¢Ø¯Ø±Ø³ Ø¸Ø§Ù‡Ø± Ø¨Ø´Ù‡ (Ø­Ø¯Ø§Ú©Ø«Ø± Û³Û° Ø«Ø§Ù†ÛŒÙ‡)
          $timeout = 30
          $start = Get-Date
          $url = $null

          while (((Get-Date) - $start).TotalSeconds -lt $timeout) {
              if (Test-Path "pinggy.log") {
                  $log = Get-Content "pinggy.log" -Raw -ErrorAction SilentlyContinue
                  if ($log) {
                      $match = [regex]::Match($log, 'tcp://[a-z0-9.-]+:\d+')
                      if ($match.Success) {
                          $url = $match.Value
                          break
                      }
                  }
              }
              Start-Sleep -Seconds 3
          }

          if ($url) {
              Write-Host "âœ… Pinggy Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯!" -ForegroundColor Green
              Write-Host "ğŸŒ Ø¢Ø¯Ø±Ø³ Ø§ØªØµØ§Ù„: $url" -ForegroundColor White
          } else {
              Write-Host "âš ï¸ Ø¢Ø¯Ø±Ø³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ (Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„):" -ForegroundColor Yellow
              Get-Content "pinggy.log" -ErrorAction SilentlyContinue
              Get-Content "pinggy.err" -ErrorAction SilentlyContinue
          }

      # â”€â”€â”€â”€â”€â”€ Û´. Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª â”€â”€â”€â”€â”€â”€
      - name: RDP Connection Info
        shell: pwsh
        run: |
          Write-Host "`n[=============================================================]" -ForegroundColor Magenta
          Write-Host "             ğŸ” RDP Û²Û´ Ø³Ø§Ø¹ØªÙ‡ Ø¢Ù…Ø§Ø¯Ù‡!             " -ForegroundColor Cyan
          Write-Host "[=============================================================]`n" -ForegroundColor Magenta

          $tsIP = (tailscale ip -4) 2>$null
          if ($tsIP) { Write-Host "ğŸŒ Tailscale IP : $tsIP" -ForegroundColor Green }

          if (Test-Path "pinggy.log") {
              $log = Get-Content "pinggy.log" -Raw
              $pinggy = [regex]::Match($log, 'tcp://[a-z0-9.-]+:\d+').Value
              if ($pinggy) { Write-Host "ğŸ”— Pinggy Address : $pinggy" -ForegroundColor Green }
          }

          Write-Host "ğŸ‘¤ Username : runneradmin" -ForegroundColor Green
          Write-Host "ğŸ”‘ Password : @SecureRDP2026" -ForegroundColor Green

          Write-Host "`nâœ… Ø³Ø±ÙˆØ± Û²Û´ Ø³Ø§Ø¹ØªÙ‡ ÙØ¹Ø§Ù„Ù‡ (Ù‡Ø± Ûµ Ø³Ø§Ø¹Øª restart Ø®ÙˆØ¯Ú©Ø§Ø±)" -ForegroundColor Green
          Write-Host "[=============================================================]`n" -ForegroundColor Magenta

      # â”€â”€â”€â”€â”€â”€ Ûµ. Auto Restart â”€â”€â”€â”€â”€â”€
      - name: Auto Restart
        if: always()
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          gh workflow run ${{ github.workflow }} --ref ${{ github.ref_name }}
