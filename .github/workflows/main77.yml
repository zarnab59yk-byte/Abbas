name: Create Secure Windows RDP (Pinggy)

on:
  workflow_dispatch:

jobs:
  create-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      # â”€â”€â”€â”€â”€â”€ Û±. ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RDP Ùˆ Ú©Ø§Ø±Ø¨Ø± â”€â”€â”€â”€â”€â”€
      - name: Enable RDP + Set Credentials
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          net user runneradmin /active:yes
          net user runneradmin "@SecureRDP2026"   # â† Ø±Ù…Ø² Ø¯Ù„Ø®ÙˆØ§Ù‡Øª Ø±Ùˆ Ø¹ÙˆØ¶ Ú©Ù†

      # â”€â”€â”€â”€â”€â”€ Û². Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Pinggy Tunnel (Ø³Ø§Ø¯Ù‡â€ŒØªØ±ÛŒÙ† Ø±ÙˆØ´) â”€â”€â”€â”€â”€â”€
      - name: Start Pinggy Tunnel
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Pinggy Tunnel..." -ForegroundColor Cyan
          
          # Ø´Ø±ÙˆØ¹ ØªÙˆÙ†Ù„ Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
          $tunnel = Start-Process -FilePath "ssh" `
            -ArgumentList "-p 443 -R0:127.0.0.1:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=5 tcp@free.pinggy.io" `
            -PassThru -NoNewWindow -RedirectStandardOutput "pinggy.log" -RedirectStandardError "pinggy.err"
          
          Write-Host "â³ Ù…Ù†ØªØ¸Ø± Ø¨Ù…ÙˆÙ† ØªØ§ ØªÙˆÙ†Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø´Ù‡ (Û±Û° Ø«Ø§Ù†ÛŒÙ‡)..." -ForegroundColor Yellow
          Start-Sleep -Seconds 15
          
          # Ù†Ù…Ø§ÛŒØ´ Ø¢Ø¯Ø±Ø³ ØªÙˆÙ†Ù„
          if (Test-Path "pinggy.log") {
              $log = Get-Content "pinggy.log" -Raw
              $url = [regex]::Match($log, 'tcp://[a-z0-9.-]+:\d+').Value
              if ($url) {
                  Write-Host "`nâœ… ØªÙˆÙ†Ù„ Pinggy Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯!" -ForegroundColor Green
                  Write-Host "ğŸŒ Ø¢Ø¯Ø±Ø³ Ø§ØªØµØ§Ù„: $url" -ForegroundColor White
              } else {
                  Write-Host "âš ï¸ Ø¢Ø¯Ø±Ø³ ØªÙˆÙ†Ù„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„:" -ForegroundColor Red
                  Get-Content "pinggy.log"
              }
          } else {
              Write-Host "âŒ Ù„Ø§Ú¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„:" -ForegroundColor Red
              Get-Content "pinggy.err"
          }

      # â”€â”€â”€â”€â”€â”€ Û³. Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ â”€â”€â”€â”€â”€â”€
      - name: RDP Connection Info
        shell: pwsh
        run: |
          Write-Host "`n[=============================================================]" -ForegroundColor Magenta
          Write-Host "                  ğŸ” Windows RDP Ø¨Ø§ Pinggy Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯!                  " -ForegroundColor Cyan
          Write-Host "[=============================================================]`n" -ForegroundColor Magenta

          Write-Host "ğŸ‘¤ Username     : " -NoNewline -ForegroundColor Green
          Write-Host "runneradmin" -ForegroundColor White

          Write-Host "ğŸ”‘ Password     : " -NoNewline -ForegroundColor Green
          Write-Host "@SecureRDP2026" -ForegroundColor White

          Write-Host "`nğŸ“Œ Ù†Ø­ÙˆÙ‡ Ø§ØªØµØ§Ù„:" -ForegroundColor Yellow
          Write-Host "   Û±. ØªÙˆÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ workflow Ø¨Ø§Ù„Ø§ØŒ Ø¢Ø¯Ø±Ø³ Ø±Ùˆ Ù¾ÛŒØ¯Ø§ Ú©Ù† (Ù…Ø«Ù„ tcp://xxxx.pinggy.link:yyyyy)" -ForegroundColor White
          Write-Host "   Û². ØªÙˆÛŒ Remote Desktop (Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± ÛŒØ§ Ú¯ÙˆØ´ÛŒ) Ø§ÛŒÙ†Ùˆ Ø¨Ø²Ù†:" -ForegroundColor White
          Write-Host "      Computer: Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ (Ù…Ø«Ù„Ø§Ù‹ tcp://xxxx.pinggy.link:yyyyy)" -ForegroundColor White
          Write-Host "      Username: runneradmin" -ForegroundColor White
          Write-Host "      Password: @SecureRDP2026" -ForegroundColor White

          Write-Host "`nâœ… Ø¨Ø±Ùˆ Ø­Ø§Ù„Ø´Ùˆ Ø¨Ø¨Ø±! (ØªØ§ Û¶ Ø³Ø§Ø¹Øª)" -ForegroundColor Green
          Write-Host "[=============================================================]`n" -ForegroundColor Magenta

      # â”€â”€â”€â”€â”€â”€ Û´. Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø²Ù†Ø¯Ù‡ â”€â”€â”€â”€â”€â”€
      - name: Keep Runner Alive
        shell: pwsh
        run: |
          Start-Sleep -Seconds 21600
